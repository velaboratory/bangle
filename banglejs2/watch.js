// Clock with large digits using the "Anton" bold font
Graphics.prototype.setFontAnton = function(scale) {
    g.setFontCustom(atob("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAA/gAAAAAAAAAAP/gAAAAAAAAAH//gAAAAAAAAB///gAAAAAAAAf///gAAAAAAAP////gAAAAAAD/////gAAAAAA//////gAAAAAP//////gAAAAH///////gAAAB////////gAAAf////////gAAP/////////gAD//////////AA//////////gAA/////////4AAA////////+AAAA////////gAAAA///////wAAAAA//////8AAAAAA//////AAAAAAA/////gAAAAAAA////4AAAAAAAA///+AAAAAAAAA///gAAAAAAAAA//wAAAAAAAAAA/8AAAAAAAAAAA/AAAAAAAAAAAAgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////AAAAAB///////8AAAAH////////AAAAf////////wAAA/////////4AAB/////////8AAD/////////+AAH//////////AAP//////////gAP//////////gAP//////////gAf//////////wAf//////////wAf//////////wAf//////////wA//8AAAAAB//4A//wAAAAAAf/4A//gAAAAAAP/4A//gAAAAAAP/4A//gAAAAAAP/4A//wAAAAAAf/4A///////////4Af//////////wAf//////////wAf//////////wAf//////////wAP//////////gAP//////////gAH//////////AAH//////////AAD/////////+AAB/////////8AAA/////////4AAAP////////gAAAD///////+AAAAAf//////4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAP/gAAAAAAAAAAP/gAAAAAAAAAAf/gAAAAAAAAAAf/gAAAAAAAAAAf/AAAAAAAAAAA//AAAAAAAAAAA/+AAAAAAAAAAB/8AAAAAAAAAAD//////////gAH//////////gAP//////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH/4AAAAB/gAAD//4AAAAf/gAAP//4AAAB//gAA///4AAAH//gAB///4AAAf//gAD///4AAA///gAH///4AAD///gAP///4AAH///gAP///4AAP///gAf///4AAf///gAf///4AB////gAf///4AD////gA////4AH////gA////4Af////gA////4A/////gA//wAAB/////gA//gAAH/////gA//gAAP/////gA//gAA///8//gA//gAD///w//gA//wA////g//gA////////A//gA///////8A//gA///////4A//gAf//////wA//gAf//////gA//gAf/////+AA//gAP/////8AA//gAP/////4AA//gAH/////gAA//gAD/////AAA//gAB////8AAA//gAA////wAAA//gAAP///AAAA//gAAD//8AAAA//gAAAP+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB/+AAAAAD/wAAB//8AAAAP/wAAB///AAAA//wAAB///wAAB//wAAB///4AAD//wAAB///8AAH//wAAB///+AAP//wAAB///+AAP//wAAB////AAf//wAAB////AAf//wAAB////gAf//wAAB////gA///wAAB////gA///wAAB////gA///w//AAf//wA//4A//AAA//wA//gA//AAAf/wA//gB//gAAf/wA//gB//gAAf/wA//gD//wAA//wA//wH//8AB//wA///////////gA///////////gA///////////gA///////////gAf//////////AAf//////////AAP//////////AAP/////////+AAH/////////8AAH///+/////4AAD///+f////wAAA///8P////gAAAf//4H///+AAAAH//gB///wAAAAAP4AAH/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/wAAAAAAAAAA//wAAAAAAAAAP//wAAAAAAAAB///wAAAAAAAAf///wAAAAAAAH////wAAAAAAA/////wAAAAAAP/////wAAAAAB//////wAAAAAf//////wAAAAH///////wAAAA////////wAAAP////////wAAA///////H/wAAA//////wH/wAAA/////8AH/wAAA/////AAH/wAAA////gAAH/wAAA///4AAAH/wAAA//+AAAAH/wAAA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gA///////////gAAAAAAAAH/4AAAAAAAAAAH/wAAAAAAAAAAH/wAAAAAAAAAAH/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB//8AAA/////+B///AAA/////+B///wAA/////+B///4AA/////+B///8AA/////+B///8AA/////+B///+AA/////+B////AA/////+B////AA/////+B////AA/////+B////gA/////+B////gA/////+B////gA/////+A////gA//gP/gAAB//wA//gf/AAAA//wA//gf/AAAAf/wA//g//AAAAf/wA//g//AAAA//wA//g//gAAA//wA//g//+AAP//wA//g////////gA//g////////gA//g////////gA//g////////gA//g////////AA//gf///////AA//gf//////+AA//gP//////+AA//gH//////8AA//gD//////4AA//gB//////wAA//gA//////AAAAAAAH////8AAAAAAAA////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//////gAAAAB///////+AAAAH////////gAAAf////////4AAB/////////8AAD/////////+AAH//////////AAH//////////gAP//////////gAP//////////gAf//////////wAf//////////wAf//////////wAf//////////wAf//////////4A//wAD/4AAf/4A//gAH/wAAP/4A//gAH/wAAP/4A//gAP/wAAP/4A//gAP/4AAf/4A//wAP/+AD//4A///wP//////4Af//4P//////wAf//4P//////wAf//4P//////wAf//4P//////wAP//4P//////gAP//4H//////gAH//4H//////AAH//4D/////+AAD//4D/////8AAB//4B/////4AAA//4A/////wAAAP/4AP////AAAAB/4AD///4AAAAAAAAAH/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//AAAAAAAAAAA//gAAAAAAAAAA//gAAAAAAAAAA//gAAAAAAADgA//gAAAAAAP/gA//gAAAAAH//gA//gAAAAB///gA//gAAAAP///gA//gAAAD////gA//gAAAf////gA//gAAB/////gA//gAAP/////gA//gAB//////gA//gAH//////gA//gA///////gA//gD///////gA//gf///////gA//h////////gA//n////////gA//////////gAA/////////AAAA////////wAAAA///////4AAAAA///////AAAAAA//////4AAAAAA//////AAAAAAA/////4AAAAAAA/////AAAAAAAA////8AAAAAAAA////gAAAAAAAA///+AAAAAAAAA///4AAAAAAAAA///AAAAAAAAAA//4AAAAAAAAAA/+AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD//gB///wAAAAP//4H///+AAAA///8P////gAAB///+f////4AAD///+/////8AAH/////////+AAH//////////AAP//////////gAP//////////gAf//////////gAf//////////wAf//////////wAf//////////wA///////////wA//4D//wAB//4A//wB//gAA//4A//gA//gAAf/4A//gA//AAAf/4A//gA//gAAf/4A//wB//gAA//4A///P//8AH//4Af//////////wAf//////////wAf//////////wAf//////////wAf//////////gAP//////////gAP//////////AAH//////////AAD/////////+AAD///+/////8AAB///8f////wAAAf//4P////AAAAH//wD///8AAAAA/+AAf//AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAH//gAAAAAAAAB///+AA/+AAAAP////gA//wAAAf////wA//4AAB/////4A//8AAD/////8A//+AAD/////+A///AAH/////+A///AAP//////A///gAP//////A///gAf//////A///wAf//////A///wAf//////A///wAf//////A///wA///////AB//4A//4AD//AAP/4A//gAB//AAP/4A//gAA//AAP/4A//gAA/+AAP/4A//gAB/8AAP/4A//wAB/8AAf/4Af//////////wAf//////////wAf//////////wAf//////////wAf//////////wAP//////////gAP//////////gAH//////////AAH/////////+AAD/////////8AAB/////////4AAAf////////wAAAP////////AAAAB///////4AAAAAD/////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAf/AAB/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAA//AAD/8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=="), 46, atob("EiAnGicnJycnJycnEw=="), 78 + (scale << 8) + (1 << 16));
  };
  
  { // must be inside our own scope here so that when we are unloaded everything disappears
    // we also define functions using 'let fn = function() {..}' for the same reason. function decls are global

  let drawTimeout;
  let syncing = false;
  let last_steps = Bangle.getStepCount();
  let hrm_buffer = [];  //we aren't going to log hrm readings immediately, because they will be written in chunks
  let hrm_raw_first_value_time = 0;
  let last_hrm_reading_time = 0;
  let last_raw_hrm_reading_time = 0;
  let version = "9";
  let movementFilename = "healthlog"+version; 
  let hrmFilename = "hrmlog"+version; 
  let hrmrawfilesFilename = "hrmrawfileslog"+version;
  let hrmRawFile = null;
  let configFilename = "config"+version;
  let reading_config = false;
  let timezone = -4;
  let max_chunk = 5000;
  let ble_mtu = 128;
  let from_time = require("Storage").read("from_time");
  let sync_files = [];

  E.setTimeZone(timezone);
  Bangle.setOptions({"hrmPollInterval": 20, "wakeOnBTN1":true,"wakeOnBTN2":true,"wakeOnBTN3":true,"wakeOnFaceUp":false,"wakeOnTouch":false,"wakeOnTwist":false});
  if(from_time === undefined){
    from_time = ""+Math.floor(Date.now() / 1000);
    require("Storage").write("from_time",from_time);
  }
  Bangle.setHRMPower(false,"myApp"); //this actually resets the poll interval
  Bangle.setHRMPower(true,"myApp");
  Bangle.setHRMPower(false,"myApp"); 

  //this function addresses the problem that you can't append to files in bangle without a special mode
  //that special mode uses 255 as a delimeter.  So, we need a way to encode arbitrary binary
  //this function uses the value 11 as an escape character. 
  //255: 11, 0
  //11: 11, 11
  let escape_value = 0x0b;
  var escaped_255 = String.fromCharCode(escape_value) + "\xFE";
  var escaped_escape = String.fromCharCode(escape_value) + "\xFE";

  
  let encode = function(buff1){
    //buff2 should be twice the size of buff1.  This will create a new array buffer of the correct size
    var toReturn = "";
    for(var i=0;i<buff1.length;i++){
        if(buff1[i] == 255){
            toReturn += escaped_255;
        }else if(buff1[i] == escape_value){
            toReturn += escaped_escape;
        }else{
            toReturn+=String.fromCharCode(buff1[i]);
        }

    }
    return toReturn;
  };

  var movement_log_buffer = new ArrayBuffer(8);
  let writeMovementLog =function() {
    if(syncing) return;
      var time = Math.floor(Date.now() / 1000);
      var steps = Bangle.getStepCount();
      var movement = Bangle.getHealthStatus().movement;
      var delta = steps - last_steps;
      last_steps = steps;
      last_movement = movement; 
      view = new DataView(movement_log_buffer);
      view.setUint32(0, time, false); // byteOffset = 0; litteEndian = false
      view.setUint16(4, delta, false);
      view.setUint16(6, movement, false);
      var file = require("Storage").open(movementFilename,"a");
      file.write(encode(movement_log_buffer));
  };
  
  var hrm_log_buffer = new ArrayBuffer(6);
  Bangle.on("HRM", function(hrm) { 
        if(syncing) return;
        var file = require("Storage").open(hrmFilename,"a");
        var view = new DataView(hrm_log_buffer);
        var time = Math.floor(Date.now() / 1000);
        view.setUint32(0,time);
        view.setUint8(4,hrm.bpm); //0 - 100
        view.setUint8(5,hrm.confidence); // 0-100
        file.write(encode(hrm_log_buffer));
  });

  var hrm_raw_log_buffer_header = new ArrayBuffer(4);
  let writeHRMRawBufferHeader = function(){
    //generate a new filename
    var filename = "hrmraw"+Math.floor(Date.now());
    hrmRawFile = require("Storage").open(filename,"a");
    require("Storage").open(hrmrawfilesFilename,"a").write(filename+"\n");
    var view = new DataView(hrm_raw_log_buffer_header);
    var time = hrm_raw_first_value_time;
    view.setUint32(0,time); //we write the time to know the offset
    hrmRawFile.write(encode(hrm_raw_log_buffer_header));
  };

  var hrm_raw_log_buffer = new ArrayBuffer(4);  //might be able to go down to 3 or even 2
  Bangle.on("HRM-raw", function(hrm) { 
        if(syncing) return;    
        var view = new DataView(hrm_raw_log_buffer);
        var now = Date.now();
        if(hrm_buffer.length == 0){
            hrm_raw_first_value_time = Math.floor(now/1000); 
        }
        var time_delta = now - last_raw_hrm_reading_time;
        last_raw_hrm_reading_time = now;
        var acc = Bangle.getAccel().diff*200;
        if(acc > 254){
            acc = 254; //we don't want to write 255, because that's a special encoded value
        }
        view.setUint8(0, time_delta);
        view.setUint16(1,hrm.raw);
        view.setUint8(3, acc); 
        hrmRawFile.write(encode(hrm_raw_log_buffer)); //add to the buffer
  });

  // Actually draw the watch face
  let draw = function() {
  

    writeMovementLog();
    
    var time = Math.floor(Date.now() / 1000);
    if(time - last_hrm_reading_time > 60*20){
        writeHRMRawBufferHeader(); //write out how many were written (must be read in reverse)
        Bangle.setHRMPower(true,"myapp");
        last_hrm_reading_time = time;
    }
    if(Bangle.isHRMOn() && (time-last_hrm_reading_time) > 60*3){
        Bangle.setHRMPower(false,"myapp"); //this should immediately stop raw readings
        
    }

    //open the file and write the data
  
    var x = g.getWidth() / 2;
    var y = g.getHeight() / 2;
    g.reset().clearRect(Bangle.appRect); // clear whole background (w/o widgets)
    var date = new Date();
    var hour = date.getHours() % 12;
    var minuteStr = (""+date.getMinutes()).padStart(2,"0");

    var timeStr = (hour == 0?"12":(""+hour)) + ":"+minuteStr;
    //var timeStr = locale.time(date, 1); // Hour and minute
    g.setFontAlign(0, 0).setFont("Anton").drawString(timeStr, x, y);
    // Show date and day of week
    var dow = date.getDay();
    days_of_week = ["Sun","Mon","Tues","Wednes","Thurs","Fri","Satur"];
    var dateStringFull = date.toString();
    var parts = dateStringFull.split(" ");
    var dateStr = parts[2]+" " + parts[1] + " " + parts[3]+"\n"+
                  days_of_week[dow].toUpperCase()+"DAY";
    g.setFontAlign(0, 0).setFont("6x8", 2).drawString(dateStr, x, y+48);
    
    // queue next draw
    if (drawTimeout) clearTimeout(drawTimeout); //
    drawTimeout = setTimeout(function() {
      drawTimeout = undefined;
      draw();
    }, 60000 - (Date.now() % 60000)); //force update on the minute
  };
  
  let storageFile = null;
  let sendData = function(){
        //write the filename
        var bytesSent = 0;

        while(true){
            s = storageFile.read(ble_mtu);
            if(s.charCodeAt(s.length - 1) == 0x11 && s.charCodeAt(s.length-2) != 0x11){
                s = s.storageFile.read(1); //one more, because this message ended in the escape cahracter
            }
            escaped_escapes = String.fromCharCode(escape_value)+String.fromCharCode(escape_value);
            escaped_255s = String.fromCharCode(escape_value)+String.fromCharCode(0);
            s.replaceAll(escaped_escapes,String.fromCharCode(escape_value));
            s.replaceAll(escaped_255s,"\xFF"); 
            if(s!=undefined){
                Bluetooth.write(s);
                bytesSent += s.length;

                if(bytesSent + ble_mtu > max_chunk){
                    return false;
                }
            }else{
                return true;
            }
        
        }
  };

  let sendFile = function(filename){
    Bluetooth.write(filename+":");
    storageFile = require("Storage").open(filename,"r");
  };

  let setupServer = function(){
      
      NRF.on('disconnect', function(reason) { 
          syncing = false;
          reading_config = false;
          Bangle.buzz();
      });
      NRF.setTxPower(8);
      // Change the name that's advertised
      //NRF.setAdvertising({}, {name:"Bangle.js"});
  };
  
  E.setConsole(null, {force: true});
  let config_buffer = "";

  currentFileIndex = 0;
  Bluetooth.on('data', function(data) {
    if(reading_config){
      
        for(var i=0;i<data.length;i++){


           if(data.charAt(i)=="\n"){
               
               config_json = atob(config_buffer);
               require("Storage").open(configFilename, "w").erase();
               require("Storage").open(configFilename, "w").write(config_json);
               reading_config = false;
               Bluetooth.write(3); //got all data
               load(); //restart
           }
           else{
               config_buffer += data[i];
           }
       }

    }else{
        if(data.charCodeAt(0) == 1){ 

            if(!syncing) {
                syncing = true;
                currentFileIndex = 0;
                sync_files = [];
                sync_files.push(movementFilename,hrmFilename);
                rawfiles = require("Storage").open(hrmrawfilesFilename).read().split("\n");
                for(var i=0;i<rawfiles.length;i++){
                    sync_files.push(rawfiles.length);
                }
                sendFile(sync_files[currentFileIndex]);
            }
            if(sendData()){
                //if we are done, go on to the next file
                currentFileIndex++;
                if(currentFileIndex >= sync_files.length){ //we are completely done, so write a 2
                    Bluetooth.flush();
                    Bluetooth.write(2);
                    Bluetooth.flush(); //ensure 1 packet
                }else{ 
                    Bluetooth.flush();
                    Bluetooth.write(10); //write a new line to indicate we are moving to the next file
                    Bluetooth.flush();
                    sendFile(sync_files[currentFileIndex]); //open the next one
                    Bluetooth.flush();
                    Bluetooth.write(1); //write a 1 to indicate that this packet is done
                    Bluetooth.flush();
                }
            }else{
                Bluetooth.flush();
                Bluetooth.write(1); //indicate a packet, but not a new file yet
                Bluetooth.flush();
            }
            
        }
        if(data.charCodeAt(0) == 2){
            for(var i=0;i<sync_files.length;i++){
                require("Storage").open(sync_files[i], "w").erase();
            }
            require("Storage").open(hrmrawfilesFilename,"w").erase();
            Bluetooth.flush();
            Bluetooth.write(2); //confirm delete
            Bluetooth.flush();
            from_time = ""+Math.floor(Date.now() / 1000); //we need to calculate a new from time
            require("Storage").write("from_time",from_time);
        }
        if(data.charCodeAt(0) == 3){
            config_buffer = ""; 
            reading_config = true;
        }
        if(data.charCodeAt(0) == 7){
            var dv = new DataView(E.toArrayBuffer(data.slice(-4)));
            var timestamp = dv.getInt32(0,false);
            E.setTimeZone(0); //set to utc before setting a utc time
            setTime(timestamp);
            E.setTimeZone(timezone); //now set to timezone

            //send back the from_time
            timestamp = parseInt(from_time);
            var message = new ArrayBuffer(5); // an Int32 takes 4 bytes and Int16 takes 2 bytes
            view = new DataView(message);
            view.setUint32(1, timestamp, false); // byteOffset = 0; litteEndian = false
            message[0] = 7;
            Bluetooth.flush();
            Bluetooth.write(message);
            Bluetooth.flush();

        }

    }
    

  });
  setupServer();
  
  // Load widgets
  //Bangle.loadWidgets(); No widgets
  draw();
  //setTimeout(Bangle.drawWidgets,0);
  }
  